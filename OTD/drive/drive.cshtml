<div class="otd-drive-window otd-hidden" id="otd-drive" role="dialog" aria-label="Fahrregler">
    <div class="otd-drive-titlebar" data-drag-handle="true">
        <span class="otd-drive-title">Fahrregler</span>
        <div class="otd-drive-title-actions">
            <span class="otd-drive-status" id="otd-drive-status">Bereit</span>
            <button class="otd-drive-close" type="button" aria-label="Schliessen" onclick="closeDriveFenster();">X</button>
        </div>
    </div>
    <div class="otd-drive-body">
        <label class="otd-drive-field">
            Lokomotive
            <select id="drive-loco-select"></select>
        </label>
        <div class="otd-drive-controls">
            <div class="otd-drive-direction-block">
                <div class="otd-drive-label">Richtung</div>
                <div class="otd-drive-direction">
                    <button type="button" id="drive-dir-forward">Vorwaerts</button>
                    <button type="button" id="drive-dir-reverse">Rueckwaerts</button>
                    <button type="button" id="drive-dir-stop">Stopp</button>
                </div>
            </div>
            <div class="otd-drive-speed-block">
                <div class="otd-drive-speed-display">
                    <span id="drive-speed-value">0</span>
                    <span class="otd-drive-speed-max">/ <span id="drive-speed-max">127</span></span>
                </div>
                <input type="range" id="drive-speed" min="0" max="127" value="0" />
                <div class="otd-drive-speed-label">Fahrstufe</div>
            </div>
        </div>
        <div class="otd-drive-gauge" id="drive-gauge">
            <div class="otd-drive-gauge-arc"></div>
            <div class="otd-drive-gauge-needle"></div>
            <div class="otd-drive-gauge-center"></div>
            <div class="otd-drive-gauge-readout"><span id="drive-speed-kmh">0</span> km/h</div>
            <div class="otd-drive-gauge-max">Vmax <span id="drive-speed-vmax">0</span></div>
        </div>
        <div class="otd-drive-section">
            <div class="otd-drive-label">Funktionen</div>
            <div class="otd-drive-functions" id="drive-functions">
                <button type="button" data-fn="0">F0</button>
                <button type="button" data-fn="1">F1</button>
                <button type="button" data-fn="2">F2</button>
                <button type="button" data-fn="3">F3</button>
                <button type="button" data-fn="4">F4</button>
                <button type="button" data-fn="5">F5</button>
                <button type="button" data-fn="6">F6</button>
                <button type="button" data-fn="7">F7</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function driveWindow() {
        const panel = document.getElementById('otd-drive');
        if (!panel) return;

        const statusEl = document.getElementById('otd-drive-status');
        const locoSelect = document.getElementById('drive-loco-select');
        const dirForward = document.getElementById('drive-dir-forward');
        const dirReverse = document.getElementById('drive-dir-reverse');
        const dirStop = document.getElementById('drive-dir-stop');
        const speedInput = document.getElementById('drive-speed');
        const speedValue = document.getElementById('drive-speed-value');
        const speedMax = document.getElementById('drive-speed-max');
        const speedKmh = document.getElementById('drive-speed-kmh');
        const speedVmax = document.getElementById('drive-speed-vmax');
        const gauge = document.getElementById('drive-gauge');
        const functionsEl = document.getElementById('drive-functions');

        const state = {
            items: [],
            loadedOnce: false
        };
        const controlState = {
            selectedId: '',
            byId: {}
        };

        function setStatus(text) {
            if (statusEl) statusEl.textContent = text;
        }

        function getControlState(id) {
            if (!id) return null;
            if (!controlState.byId[id]) {
                controlState.byId[id] = {
                    direction: 'forward',
                    speed: 0,
                    functions: Array.from({ length: 8 }, () => false)
                };
            }
            return controlState.byId[id];
        }

        function setDirectionUI(direction) {
            const map = {
                forward: dirForward,
                reverse: dirReverse,
                stop: dirStop
            };
            Object.values(map).forEach(btn => btn?.classList.remove('is-active'));
            map[direction]?.classList.add('is-active');
        }

        function setControlsEnabled(enabled) {
            [dirForward, dirReverse, dirStop, speedInput].forEach((el) => {
                if (el) el.disabled = !enabled;
            });
            functionsEl?.querySelectorAll('button').forEach((btn) => {
                btn.disabled = !enabled;
            });
        }

        function syncUI() {
            const id = controlState.selectedId;
            const loco = state.items.find(item => item.id === id);
            if (!loco) {
                setControlsEnabled(false);
                if (speedValue) speedValue.textContent = '0';
                if (speedMax) speedMax.textContent = '127';
                if (speedKmh) speedKmh.textContent = '0';
                if (speedVmax) speedVmax.textContent = '0';
                if (gauge) gauge.style.setProperty('--otd-needle-rotation', '-120deg');
                return;
            }
            setControlsEnabled(true);
            if (speedMax) speedMax.textContent = '127';
            if (speedInput) speedInput.max = '127';
            const control = getControlState(id);
            const nextSpeed = Math.min(control.speed, 127);
            control.speed = nextSpeed;
            if (speedInput) speedInput.value = nextSpeed.toString();
            if (speedValue) speedValue.textContent = nextSpeed.toString();
            const vmax = Number.parseInt(loco.vmax ?? '', 10);
            const maxSpeed = Number.isFinite(vmax) && vmax > 0 ? vmax : 0;
            const currentSpeed = maxSpeed > 0 ? Math.round((nextSpeed / 127) * maxSpeed) : 0;
            if (speedKmh) speedKmh.textContent = currentSpeed.toString();
            if (speedVmax) speedVmax.textContent = maxSpeed.toString();
            if (gauge) {
                const angle = -120 + (nextSpeed / 127) * 240;
                gauge.style.setProperty('--otd-needle-rotation', `${angle}deg`);
            }
            setDirectionUI(control.direction);
            functionsEl?.querySelectorAll('button').forEach((btn) => {
                const index = Number.parseInt(btn.dataset.fn ?? '', 10);
                const active = Number.isFinite(index) ? control.functions[index] : false;
                btn.classList.toggle('is-active', !!active);
            });
        }

        function renderLocos() {
            if (!locoSelect) return;
            const current = locoSelect.value || controlState.selectedId || '';
            locoSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Lok waehlen';
            locoSelect.appendChild(placeholder);
            for (const item of state.items) {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name || item.id;
                locoSelect.appendChild(option);
            }
            const next = state.items.some(item => item.id === current)
                ? current
                : state.items[0]?.id ?? '';
            locoSelect.value = next;
            controlState.selectedId = next;
            syncUI();
        }

        async function loadFromServer() {
            try {
                setStatus('Laden ...');
                const resp = await fetch('/loco.xml', { cache: 'no-store' });
                if (!resp.ok) {
                    state.items = [];
                    renderLocos();
                    setStatus('Keine loco.xml gefunden');
                    state.loadedOnce = true;
                    return;
                }
                const xml = await resp.text();
                const doc = new DOMParser().parseFromString(xml, 'application/xml');
                const list = [];
                doc.querySelectorAll('locos > loco').forEach(node => {
                    list.push({
                        id: node.getAttribute('id') || crypto.randomUUID(),
                        name: node.querySelector('name')?.textContent ?? '',
                        vmax: node.querySelector('vmax')?.textContent ?? ''
                    });
                });
                state.items = list;
                renderLocos();
                setStatus(`Geladen (${list.length} Eintraege)`);
                state.loadedOnce = true;
            } catch {
                setStatus('Laden fehlgeschlagen');
            }
        }

        locoSelect?.addEventListener('change', () => {
            controlState.selectedId = locoSelect.value;
            syncUI();
        });
        dirForward?.addEventListener('click', () => {
            const control = getControlState(controlState.selectedId);
            if (!control) return;
            control.direction = 'forward';
            setDirectionUI(control.direction);
        });
        dirReverse?.addEventListener('click', () => {
            const control = getControlState(controlState.selectedId);
            if (!control) return;
            control.direction = 'reverse';
            setDirectionUI(control.direction);
        });
        dirStop?.addEventListener('click', () => {
            const control = getControlState(controlState.selectedId);
            if (!control) return;
            control.direction = 'stop';
            setDirectionUI(control.direction);
        });
        speedInput?.addEventListener('input', () => {
            const control = getControlState(controlState.selectedId);
            if (!control || !speedValue) return;
            const value = Number.parseInt(speedInput.value, 10) || 0;
            control.speed = value;
            speedValue.textContent = value.toString();
        });
        functionsEl?.addEventListener('click', (evt) => {
            const btn = evt.target.closest('button');
            if (!btn) return;
            const control = getControlState(controlState.selectedId);
            if (!control) return;
            const index = Number.parseInt(btn.dataset.fn ?? '', 10);
            if (!Number.isFinite(index)) return;
            control.functions[index] = !control.functions[index];
            btn.classList.toggle('is-active', control.functions[index]);
        });

        window.openDriveFenster = function () {
            panel.classList.remove('otd-hidden');
            if (!panel.style.left || !panel.style.top) {
                const workspace = document.querySelector('.otd-workspace');
                const rect = workspace?.getBoundingClientRect();
                const width = panel.offsetWidth || 320;
                const height = panel.offsetHeight || 360;
                const left = rect ? Math.max(12, (rect.width - width) / 2) : 12;
                const top = rect ? Math.max(12, (rect.height - height) / 2) : 12;
                panel.style.left = `${left}px`;
                panel.style.top = `${top}px`;
            }
            if (!state.loadedOnce) {
                loadFromServer();
            }
        };

        window.closeDriveFenster = function () {
            panel.classList.add('otd-hidden');
        };
    })();
</script>
