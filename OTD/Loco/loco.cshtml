<div class="otd-loco-window otd-hidden" id="otd-loco" role="dialog" aria-label="Lokomotiven">
    <div class="otd-loco-titlebar" data-drag-handle="true">
        <span class="otd-loco-title">Lokomotiven</span>
        <div class="otd-loco-title-actions">
            <span class="otd-loco-status" id="otd-loco-status">Bereit</span>
            <button class="otd-loco-close" type="button" aria-label="Schliessen" onclick="closeLokoFenster();">X</button>
        </div>
    </div>
    <div class="otd-loco-body">
        <div class="otd-loco-form">
            <label>
                Name
                <input type="text" id="loco-name" maxlength="10" />
            </label>
            <label>
                Address
                <input type="number" id="loco-address" min="1" max="1024" />

            </label>
            <label>
                Length (cm)
                <input type="number" id="loco-length" min="0" max="50" />
            </label>
            <label>
                Vmax (km/h)
                <input type="number" id="loco-vmax" min="1" max="500" />
            </label>
            <label>
                Vmin (km/h)
                <input type="number" id="loco-vmin" min="1" max="500" />
            </label>
            <label class="otd-loco-notes">
                Notes
                <textarea id="loco-notes" rows="2" maxlength="240"></textarea>
            </label>
            <div class="otd-loco-buttons">
                <button type="button" id="loco-new">Neu</button>
                <button type="button" id="loco-add">Hinzufuegen / Aktualisieren</button>
                <button type="button" id="loco-delete">Loeschen</button>
                <button type="button" id="loco-save">Speichern</button>
            </div>
        </div>
        <div class="otd-loco-list">
            <div class="otd-loco-list-head">
                <span>Vorhandene Lokomotiven</span>
                <button type="button" id="loco-reload">Aktualisieren</button>
            </div>
            <div class="otd-loco-list-table">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>address</th>
                            <th>Length</th>
                            <th>Vmax</th>
                            <th>VMin</th>
                            <th>Notes</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="loco-rows"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Lokomotiven Fenster ---
    (function locoEditor() {
        const panel = document.getElementById('otd-loco');
        if (!panel) return;

        const statusEl = document.getElementById('otd-loco-status');
        const nameInput = document.getElementById('loco-name');
        const addressInput = document.getElementById('loco-address');
        const lengthInput = document.getElementById('loco-length');
        const vmaxInput = document.getElementById('loco-vmax');
        const vminInput = document.getElementById('loco-vmin');
        const notesInput = document.getElementById('loco-notes');
        const rowsBody = document.getElementById('loco-rows');
        const addBtn = document.getElementById('loco-add');
        const newBtn = document.getElementById('loco-new');
        const deleteBtn = document.getElementById('loco-delete');
        const saveBtn = document.getElementById('loco-save');
        const reloadBtn = document.getElementById('loco-reload');

        const state = {
            items: [],
            selectedId: null,
            loadedOnce: false
        };

        function setStatus(text) {
            if (statusEl) statusEl.textContent = text;
        }

        function resetForm() {
            nameInput.value = '';
            addressInput.value = '';
            lengthInput.value = '';
            vmaxInput.value = '';
            vminInput.value = '';
            notesInput.value = '';
            state.selectedId = null;
            addBtn.textContent = 'Hinzufuegen / Aktualisieren';
        }

        function renderList() {
            rowsBody.innerHTML = '';
            for (const item of state.items) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name ?? ''}</td>
                    <td>${item.address ?? ''}</td>
                    <td>${item.length ?? ''}</td>
                    <td>${item.vmax ?? ''}</td>
                    <td>${item.vmin ?? ''}</td>
                    <td>${item.notes ?? ''}</td>
                    <td class="otd-loco-actions-cell">
                        <button type="button" data-id="${item.id}" class="otd-loco-row-edit">Bearbeiten</button>
                        <button type="button" data-id="${item.id}" class="otd-loco-row-delete">Entfernen</button>
                    </td>
                `;
                tr.dataset.id = item.id ?? '';
                tr.draggable = true;
                rowsBody.appendChild(tr);
            }
        }

        function fillForm(item) {
            nameInput.value = item.name ?? '';
            addressInput.value = item.address ?? '';
            lengthInput.value = item.length ?? '';
            vmaxInput.value = item.vmax ?? '';
            vminInput.value = item.vmin ?? '';
            notesInput.value = item.notes ?? '';
            state.selectedId = item.id;
            addBtn.textContent = 'Aktualisieren';
        }

        async function loadFromServer() {
            try {
                setStatus('Laden ...');
                const resp = await fetch('/loco.xml', { cache: 'no-store' });
                if (!resp.ok) {
                    state.items = [];
                    renderList();
                    setStatus('Keine loco.xml gefunden - neue Datei anlegen');
                    state.loadedOnce = true;
                    return;
                }
                const xml = await resp.text();
                const doc = new DOMParser().parseFromString(xml, 'application/xml');
                const list = [];
                doc.querySelectorAll('locos > loco').forEach(node => {
                    list.push({
                        id: node.getAttribute('id') || crypto.randomUUID(),
                        name: node.querySelector('name')?.textContent ?? '',
                        address: node.querySelector('address')?.textContent ?? '',
                        length: node.querySelector('length')?.textContent ?? '',
                        vmax: node.querySelector('vmax')?.textContent ?? '',
                        vmin: node.querySelector('vmin')?.textContent ?? '',
                        notes: node.querySelector('notes')?.textContent ?? ''
                    });
                });
                state.items = list;
                renderList();
                setStatus(`Geladen (${list.length} Eintraege)`);
                state.loadedOnce = true;
            } catch (err) {
                setStatus('Laden fehlgeschlagen');
            }
        }

        async function saveToServer() {
            try {
                setStatus('Speichere ...');
                const resp = await fetch('/loco/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(state.items)
                });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                setStatus(`Gespeichert (${state.items.length} Eintraege)`);
            } catch (err) {
                setStatus('Speichern fehlgeschlagen');
            }
        }

        function addOrUpdate() {
            const name = nameInput.value.trim();
            if (!name) {
                setStatus('Name wird benoetigt');
                return;
            }
            const id = state.selectedId ?? crypto.randomUUID();
            const existing = state.items.find(i => i.id === id);
            const payload = {
                id,
                name,
                address: addressInput.value.trim(),
                length: lengthInput.value.trim(),
                vmax: vmaxInput.value.trim(),
                vmin: vminInput.value.trim(),
                notes: notesInput.value.trim()
            };
            if (existing) {
                Object.assign(existing, payload);
            } else {
                state.items.push(payload);
            }
            renderList();
            state.selectedId = id;
            addBtn.textContent = 'Aktualisieren';
            setStatus('Lokomotive uebernommen (nicht gespeichert)');
        }

        rowsBody.addEventListener('click', (evt) => {
            const editBtn = evt.target.closest('.otd-loco-row-edit');
            const delBtn = evt.target.closest('.otd-loco-row-delete');
            if (editBtn) {
                const item = state.items.find(i => i.id === editBtn.dataset.id);
                if (item) fillForm(item);
            } else if (delBtn) {
                state.items = state.items.filter(i => i.id !== delBtn.dataset.id);
                if (state.selectedId === delBtn.dataset.id) {
                    state.selectedId = null;
                    resetForm();
                }
                renderList();
                setStatus('Geloescht (nicht gespeichert)');
            }
        });

        rowsBody.addEventListener('dragstart', (evt) => {
            const row = evt.target.closest('tr');
            if (!row) return;
            const item = state.items.find(i => i.id === row.dataset.id);
            if (!item) return;
            const payload = {
                type: 'loco',
                id: item.id,
                name: item.name,
                length: item.length,
                vmax: item.vmax
            };
            evt.dataTransfer?.setData('application/json', JSON.stringify(payload));
            evt.dataTransfer?.setDragImage(row, 16, 16);
        });

        async function deleteSelected() {
            if (!state.selectedId) {
                setStatus('Kein Eintrag ausgewaehlt');
                return;
            }
            state.items = state.items.filter(i => i.id !== state.selectedId);
            state.selectedId = null;
            resetForm();
            renderList();
            setStatus('Geloescht');
            await saveToServer();
        }

        addBtn?.addEventListener('click', addOrUpdate);
        newBtn?.addEventListener('click', () => resetForm());
        deleteBtn?.addEventListener('click', deleteSelected);
        saveBtn?.addEventListener('click', saveToServer);
        reloadBtn?.addEventListener('click', loadFromServer);

        window.openLokoFenster = function () {
            panel.classList.remove('otd-hidden');
            if (!panel.style.left || !panel.style.top) {
                const workspace = document.querySelector('.otd-workspace');
                const rect = workspace?.getBoundingClientRect();
                const width = panel.offsetWidth || 720;
                const height = panel.offsetHeight || 360;
                const left = rect ? Math.max(12, (rect.width - width) / 2) : 12;
                const top = rect ? Math.max(12, (rect.height - height) / 2) : 12;
                panel.style.left = `${left}px`;
                panel.style.top = `${top}px`;
            }
            if (!state.loadedOnce) {
                loadFromServer();
            }
        };

        window.closeLokoFenster = function () {
            panel.classList.add('otd-hidden');
        };
    })();
</script>
