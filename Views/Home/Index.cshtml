@{
    ViewData["Title"] = "Start";
    ViewData["FullBleed"] = true;
}
@section Styles {
    <link rel="stylesheet" href="~/elements/symbols.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/loco/loco.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/drive/drive.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/railcar/railcar.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/train/trains.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/timetable/timetable.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/timetable-viewer/timetableviewer.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/zd/zd.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/auth/auth.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/exit/exit.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/settings/settings.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/symbols/plan-editor.css" asp-append-version="true" />
}

     
<div class="otd-shell">
    <header class="otd-topbar">
        <div class="otd-brand">
            <div class="otd-brand-menu">
                <button class="otd-brand-trigger" type="button" aria-haspopup="true">
                    <span class="otd-brand-badge">OpenTrainDrive</span>
                </button>
                <div class="otd-dropdown otd-brand-dropdown" role="menu">
                    <button class="otd-dropdown-button" type="button">Oeffnen</button>
                    <button class="otd-dropdown-button" type="button">Speichern</button>
                    <button class="otd-dropdown-button" type="button">Speichern unter</button>
                </div>
            </div>
        </div>
        <nav class="otd-nav" aria-label="Hauptnavigation">
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">System</button>
                <div class="otd-dropdown" role="menu">
                    <a role="menuitem" href="#">Status</a>
                    <a role="menuitem" href="#">Verbindungen</a>
                    <a role="menuitem" href="#">Logs</a>
                    <div class="otd-dropdown-submenu">
                        <button class="otd-dropdown-button otd-submenu-trigger" type="button">Meldeverwalter &gt;</button>
                        <div class="otd-dropdown otd-dropdown-submenu-panel" role="menu">
                            <button class="otd-dropdown-button" type="button" onclick="openMeldeverwalter('horizontal');">Horizontal</button>
                            <button class="otd-dropdown-button" type="button" onclick="openMeldeverwalter('vertical');">Vertikal</button>
                        </div>
                    </div>
                    <button class="otd-dropdown-button" type="button" onclick="openExitFenster();">Beenden</button>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">ZN/ZL</button>
                <div class="otd-dropdown" role="menu">
                    <a role="menuitem" href="#">Zugnummern</a>
                    <a role="menuitem" href="#">Zuglenkung</a>
                    <a role="menuitem" href="#">Prioritaeten</a>
                    <button class="otd-dropdown-button" type="button" onclick="openZugDatenFenster();">Zugdaten bearbeiten</button>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">Zugdaten</button>
                <div class="otd-dropdown" role="menu">
                    <button class="otd-dropdown-button" type="button" onclick="openLokoFenster();">Lokomotiven</button>
                    <button class="otd-dropdown-button" type="button" onclick="openDriveFenster();">Fahrregler</button>
                    <button class="otd-dropdown-button" type="button" onclick="openWaggonFenster();">Waggons</button>
                    <button class="otd-dropdown-button" type="button" onclick="openTrainFenster();">Zuege</button>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">Fahrplan</button>
                <div class="otd-dropdown" role="menu">
                    <button class="otd-dropdown-button" type="button" onclick="openTimetableFenster();">Fahrplan bearbeiten</button>
                    <button class="otd-dropdown-button" type="button" onclick="openTimetableViewer();">Fahrplananzeiger</button>
                    <a role="menuitem" href="#">Zuege</a>
                    <a role="menuitem" href="#">Umlaeufe</a>
                    <a role="menuitem" href="#">Fahrzeiten</a>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">Gleisplan</button>
                <div class="otd-dropdown" role="menu">
                    <button class="otd-dropdown-button" type="button" id="otd-menu-edit">Plan bearbeiten</button>
                    <button class="otd-dropdown-button" type="button" id="otd-menu-save">Speichern</button>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">Gleismelder</button>
                <div class="otd-dropdown" role="menu">
                    <a role="menuitem" href="#">Uebersicht</a>
                    <a role="menuitem" href="#">Stoerungen</a>
                    <a role="menuitem" href="#">Test</a>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">Uebersichtsbilder</button>
                <div class="otd-dropdown" role="menu">
                    <a role="menuitem" href="#">Bahnhof</a>
                    <a role="menuitem" href="#">Strecke</a>
                    <a role="menuitem" href="#">Knoten</a>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">Lupenbilder</button>
                <div class="otd-dropdown" role="menu">
                    <button class="otd-dropdown-button" type="button" onclick="openLupenbild();">Lupenbild anzeigen</button>
                    <div class="otd-dropdown-separator"></div>
                    <a role="menuitem" href="#">Kamerapositionen</a>
                    <a role="menuitem" href="#">Zoom</a>
                    <a role="menuitem" href="#">Archiv</a>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">RBC</button>
                <div class="otd-dropdown" role="menu">
                    <a role="menuitem" href="#">Status</a>
                    <a role="menuitem" href="#">Telegramme</a>
                    <a role="menuitem" href="#">Verbindungsinfo</a>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">Konfiguration</button>
                <div class="otd-dropdown" role="menu">
                    <a role="menuitem" href="#">Projekte</a>
                    <a role="menuitem" href="#">Benutzer</a>
                    <button class="otd-dropdown-button" type="button" onclick="openSettingsFenster();">Einstellungen</button>
                </div>
            </div>
            <div class="otd-nav-item">
                <button class="otd-nav-trigger" type="button" aria-haspopup="true">?</button>
                <div class="otd-dropdown" role="menu">
                    <a role="menuitem" href="#">Hilfe</a>
                    <a role="menuitem" href="#">Info</a>
                    <a role="menuitem" href="#">Support</a>
                </div>
            </div>
        </nav>
        <div class="otd-status">
            <span class="otd-status-time" id="otd-zeit"></span>
        </div>
    </header>

    <section class="otd-workspace">
        <div class="otd-plan-canvas" id="otd-plan-canvas" aria-label="Gleisplan"></div>
        <div class="otd-plan-editor otd-hidden" id="otd-plan-editor" role="dialog" aria-label="Gleisplan bearbeiten">
            <div class="otd-plan-editor-titlebar" data-drag-handle="true">
                <span class="otd-plan-editor-title">Gleisbild Editor</span>
                <div class="otd-plan-editor-actions">
                    <div class="otd-plan-zoom">
                        <button type="button" id="otd-plan-zoom-out">-</button>
                        <span id="otd-plan-zoom-level">100%</span>
                        <button type="button" id="otd-plan-zoom-in">+</button>
                        <button type="button" id="otd-plan-zoom-reset">Reset</button>
                    </div>
                    <span class="otd-plan-status" id="otd-plan-status">Bereit</span>
                    <button type="button" class="otd-plan-editor-close" id="otd-plan-close">X</button>
                </div>
            </div>
            <div class="otd-plan-editor-body">
                <div class="otd-plan-palette">
                    <div class="otd-plan-palette-head">
                        <span>Symbole</span>
                        <input type="text" id="otd-plan-search" placeholder="Suche..." />
                    </div>
                    <div class="otd-plan-palette-list" id="otd-plan-palette"></div>
                </div>
                <div class="otd-plan-config">
                    <div class="otd-plan-config-head">
                        <span>Konfiguration</span>
                        <button type="button" id="otd-plan-add-field">Feld +</button>
                    </div>
                    <div class="otd-plan-config-body" id="otd-plan-config-body"></div>
                    <div class="otd-plan-config-actions">
                        <button type="button" id="otd-plan-save">Speichern</button>
                        <button type="button" id="otd-plan-duplicate">Duplizieren</button>
                        <button type="button" id="otd-plan-delete">Loeschen</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="otd-plan-context otd-hidden" id="otd-plan-context" role="menu">
            <button type="button" id="otd-plan-context-edit">Bearbeiten</button>
            <button type="button" id="otd-plan-context-duplicate">Duplizieren</button>
            <button type="button" id="otd-plan-context-delete">Loeschen</button>
        </div>
        <div class="otd-plan-object otd-hidden" id="otd-plan-object" role="dialog" aria-label="Objekt konfigurieren">
            <div class="otd-plan-object-titlebar" data-drag-handle="true">
                <span class="otd-plan-object-title">Objekt</span>
                <button type="button" class="otd-plan-object-close" id="otd-plan-object-close">X</button>
            </div>
            <div class="otd-plan-object-body" id="otd-plan-object-body"></div>
        </div>

        <div class="otd-lupenbild otd-lupenbild--lupe otd-hidden" id="otd-lupenbild" role="dialog" aria-label="Lupenbild">
            <div class="otd-lupenbild-titlebar" data-drag-handle="true">
                <span class="otd-lupenbild-title">Lupenbild</span>
                <button class="otd-lupenbild-close" type="button" aria-label="Schliessen" onclick="closeLupenbild();">X</button>
            </div>
            <div class="otd-lupenbild-menubar">
                <button class="otd-lupenbild-menuitem" type="button">Bild</button>
                <button class="otd-lupenbild-menuitem" type="button">Optionen</button>
                <button class="otd-lupenbild-menuitem" type="button">Texte</button>
            </div>
            <div class="otd-lupe-frame">
                <div class="otd-lupe-canvas" aria-label="Lupenbild Inhalt">
                    <svg viewBox="0 0 1000 260" width="100%" height="100%" preserveAspectRatio="none" aria-hidden="true">
                        <rect x="0" y="0" width="1000" height="260" fill="#000" />

                        <g fill="none" stroke="#fff" stroke-width="3" stroke-linecap="square" stroke-linejoin="miter">
                            <path d="M40 140 H420" />
                            <path d="M420 140 H640" />
                            <path d="M640 140 H1000" />
                            <path d="M640 140 v60 h170" />
                        </g>

                        <g fill="none" stroke="#ff0000" stroke-width="3" stroke-linecap="square" stroke-linejoin="miter">
                            <path d="M240 126 l20 14 -20 14" />
                            <path d="M400 126 l-20 14 20 14" />
                            <path d="M560 126 l20 14 -20 14" />
                            <path d="M820 126 l-20 14 20 14" />
                        </g>

                        <g fill="#30dc30" stroke="#30dc30" stroke-width="0">
                            <rect x="340" y="78" width="120" height="34" fill="transparent" stroke="#6b6b6b" stroke-width="1" />
                            <text x="400" y="103" font-family="Trebuchet MS, Verdana, sans-serif" font-size="28" text-anchor="middle">LUET</text>
                            <rect x="480" y="78" width="44" height="34" fill="transparent" stroke="#6b6b6b" stroke-width="1" />
                            <path d="M505 87 l-16 8 16 8" fill="none" stroke="#30dc30" stroke-width="3" />
                        </g>

                        <g fill="#ff0000" stroke="#ff0000" stroke-width="0">
                            <rect x="540" y="78" width="64" height="34" fill="transparent" stroke="#6b6b6b" stroke-width="1" />
                            <text x="572" y="103" font-family="Trebuchet MS, Verdana, sans-serif" font-size="28" text-anchor="middle">AB</text>
                        </g>

                        <g fill="#fff" stroke="#fff" stroke-width="0">
                            <rect x="620" y="78" width="44" height="34" fill="transparent" stroke="#6b6b6b" stroke-width="1" />
                            <path d="M635 87 l16 8 -16 8" fill="none" stroke="#fff" stroke-width="3" />
                        </g>

                        <g fill="#fff" font-family="Trebuchet MS, Verdana, sans-serif" font-size="22">
                            <text x="60" y="92" opacity="0.85">Bild</text>
                            <text x="120" y="92" opacity="0.85">Optionen</text>
                            <text x="225" y="92" opacity="0.85">Texte</text>

                            <text x="40" y="136">BAZ</text>
                            <text x="890" y="136">BUET</text>

                            <text x="150" y="136">808</text>
                            <text x="210" y="136">11</text>
                            <text x="350" y="136">1</text>
                            <text x="690" y="136">81</text>
                            <text x="690" y="176">82</text>
                            <text x="790" y="136">811</text>

                            <text x="250" y="226">km9.909</text>
                            <text x="660" y="254">km10.665</text>
                            <text x="850" y="226">km11.215</text>
                            <text x="850" y="254">km11.427</text>
                        </g>

                        <g stroke="#6b6b6b" stroke-width="2">
                            <path d="M290 114 v80" />
                            <path d="M320 114 v80" />
                            <path d="M760 114 v80" />
                            <path d="M790 114 v80" />
                        </g>

                        <g fill="#30dc30" stroke="#30dc30" stroke-width="0">
                            <rect x="320" y="175" width="6" height="22" />
                            <rect x="750" y="160" width="6" height="22" />
                        </g>
                    </svg>
                </div>
            </div>
        </div>
<div class="otd-melde-panel otd-hidden" id="otd-melde-panel" aria-label="Meldeverwalter">
            <div class="otd-melde-titlebar">
                <span class="otd-melde-title">Projektname</span>
                <button class="otd-melde-close-button" type="button" onclick="closeMeldeverwalter();">X</button>
            </div>
            <div class="otd-melde-columns" id="otd-melde-columns">
                <div class="otd-melde-column">
                    <div class="otd-melde-header">Bedienaufforderungen</div>
                    <div class="otd-melde-body" data-section="bedien">
                        <div class="otd-melde-item otd-melde-item-green">Weiche 12 pruefen</div>
                        <div class="otd-melde-item otd-melde-item-green">Bahnuebergang quittieren</div>
                    </div>
                </div>
                <div class="otd-melde-column">
                    <div class="otd-melde-header">Betriebsmeldungen</div>
                    <div class="otd-melde-body" data-section="betrieb">
                        <div class="otd-melde-item otd-melde-item-blue">Zug 4711 abgefahren</div>
                        <div class="otd-melde-item otd-melde-item-blue">Signal S5 auf Fahrt</div>
                    </div>
                </div>
                <div class="otd-melde-column">
                    <div class="otd-melde-header">Stoerungen</div>
                    <div class="otd-melde-body" data-section="stoerung">
                        <div class="otd-melde-item otd-melde-item-red">SCRS W 5 keine Ueberwachung</div>
                        <div class="otd-melde-item otd-melde-item-red">SCRS W 5 aufgeschnitten</div>
                    </div>
                </div>
                <div class="otd-melde-column">
                    <div class="otd-melde-header">System</div>
                    <div class="otd-melde-body" data-section="system">
                        <div class="otd-melde-item otd-melde-item-gray">Serverstart abgeschlossen</div>
                        <div class="otd-melde-item otd-melde-item-gray">Projekt Praettigau geladen</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

@await Html.PartialAsync("~/OTD/Loco/loco.cshtml")
@await Html.PartialAsync("~/OTD/drive/drive.cshtml")
@await Html.PartialAsync("~/OTD/railcar/railcar.cshtml")
@await Html.PartialAsync("~/OTD/Train/train.cshtml")
@await Html.PartialAsync("~/OTD/timetable/timetable.cshtml")
@await Html.PartialAsync("~/OTD/timetable-viewer/timetableviewer.cshtml")
@await Html.PartialAsync("~/OTD/ZD/zd.cshtml")
@await Html.PartialAsync("~/OTD/auth/auth.cshtml")
@await Html.PartialAsync("~/OTD/exit/exit.cshtml")
@await Html.PartialAsync("~/OTD/settings.cshtml")

<script src="~/symbols/plan-editor.js" asp-append-version="true"></script>
<script>
    function requestFullscreenOnFirstInteraction() {
        const root = document.documentElement;
        if (!root.requestFullscreen) {
            return;
        }
        const handler = () => {
            root.requestFullscreen().catch(() => { });
            window.removeEventListener('click', handler);
            window.removeEventListener('keydown', handler);
        };
        window.addEventListener('click', handler, { once: true });
        window.addEventListener('keydown', handler, { once: true });
    }

    function updateZeit() {
        const datum = new Date();
        const tag = datum.getDate().toString().padStart(2, '0');
        const monat = (datum.getMonth() + 1).toString().padStart(2, '0');
        const jahr = datum.getFullYear().toString();
        const stunden = datum.getHours().toString().padStart(2, '0');
        const minuten = datum.getMinutes().toString().padStart(2, '0');
        const sekunden = datum.getSeconds().toString().padStart(2, '0');

        const text = `${tag}.${monat}.${jahr} ${stunden}:${minuten}:${sekunden}`;
        document.getElementById('otd-zeit').textContent = text;
    }

    requestFullscreenOnFirstInteraction();
    updateZeit();
    setInterval(updateZeit, 1000);

    function openMeldeverwalter(layout) {
        const panel = document.getElementById('otd-melde-panel');
        const columns = document.getElementById('otd-melde-columns');
        panel.classList.remove('otd-hidden');
        panel.classList.remove('otd-melde-left');
        columns.classList.remove('otd-melde-vertical');

        if (layout === 'vertical') {
            panel.classList.add('otd-melde-left');
            columns.classList.add('otd-melde-vertical');
        }
    }

    function closeMeldeverwalter() {
        const panel = document.getElementById('otd-melde-panel');
        panel.classList.add('otd-hidden');
    }

    function openLupenbild() {
        const panel = document.getElementById('otd-lupenbild');
        panel.classList.remove('otd-hidden');

        if (!panel.style.left && !panel.style.top) {
            const workspace = document.querySelector('.otd-workspace');
            const rect = workspace?.getBoundingClientRect();
            const width = panel.offsetWidth || 720;
            const height = panel.offsetHeight || 340;
            const left = rect ? Math.max(12, (rect.width - width) / 2) : 12;
            const top = rect ? Math.max(12, (rect.height - height) / 2) : 12;
            panel.style.left = `${left}px`;
            panel.style.top = `${top}px`;
        }
    }

    function closeLupenbild() {
        const panel = document.getElementById('otd-lupenbild');
        panel.classList.add('otd-hidden');
    }

    (function enableLupenbildDragging() {
        const panel = document.getElementById('otd-lupenbild');
        const handle = panel?.querySelector('[data-drag-handle="true"]');
        if (!panel || !handle) {
            return;
        }

        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;
        let dragging = false;

        const onPointerMove = (event) => {
            if (!dragging) {
                return;
            }
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;
            panel.style.left = `${startLeft + dx}px`;
            panel.style.top = `${startTop + dy}px`;
        };

        const onPointerUp = () => {
            dragging = false;
            window.removeEventListener('pointermove', onPointerMove);
            window.removeEventListener('pointerup', onPointerUp);
        };

        handle.addEventListener('pointerdown', (event) => {
            if (event.button !== 0) {
                return;
            }
            dragging = true;
            startX = event.clientX;
            startY = event.clientY;
            startLeft = panel.offsetLeft;
            startTop = panel.offsetTop;
            window.addEventListener('pointermove', onPointerMove);
            window.addEventListener('pointerup', onPointerUp);
        });
    })();

    function enablePanelDragging(panelId) {
        const panel = document.getElementById(panelId);
        const handle = panel?.querySelector('[data-drag-handle="true"]');
        if (!panel || !handle) {
            return;
        }

        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;
        let dragging = false;

        const onPointerMove = (event) => {
            if (!dragging) {
                return;
            }
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;
            panel.style.left = `${startLeft + dx}px`;
            panel.style.top = `${startTop + dy}px`;
        };

        const onPointerUp = () => {
            dragging = false;
            window.removeEventListener('pointermove', onPointerMove);
            window.removeEventListener('pointerup', onPointerUp);
        };

        handle.addEventListener('pointerdown', (event) => {
            if (event.button !== 0) {
                return;
            }
            dragging = true;
            startX = event.clientX;
            startY = event.clientY;
            startLeft = panel.offsetLeft;
            startTop = panel.offsetTop;
            window.addEventListener('pointermove', onPointerMove);
            window.addEventListener('pointerup', onPointerUp);
        });
    }

    enablePanelDragging('otd-melde-panel');
    enablePanelDragging('otd-loco');
    enablePanelDragging('otd-drive');
    enablePanelDragging('otd-railcar');
    enablePanelDragging('otd-train');
    enablePanelDragging('otd-timetable');
    enablePanelDragging('otd-timetableviewer');
    enablePanelDragging('otd-zd');
    enablePanelDragging('otd-exit');
    enablePanelDragging('otd-settings');
    enablePanelDragging('otd-plan-editor');

   
    document.addEventListener('click', (event) => {
        const item = event.target.closest('.otd-melde-item');
        if (!item) {
            return;
        }
        const body = item.closest('.otd-melde-body');
        const section = body?.getAttribute('data-section');
        if (section === 'system') {
            item.remove();
            return;
        }
        item.classList.remove(
            'otd-melde-item-green',
            'otd-melde-item-blue',
            'otd-melde-item-red',
            'otd-melde-item-gray'
        );
        item.classList.add('otd-melde-item-ack');
    });
</script>







